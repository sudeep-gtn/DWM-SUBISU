<!-- 
<div class="p-4">
    <h3 class="text-lg font-semibold">Details</h3>
    <h1> {{ ticket.ticket_title }} </h1>
    <p class="text-gray-500">{{ ticket.ticket_description }}</p>
    <h3 class="text-lg font-semibold mt-4">Comments</h3>
    <div class=" mt-2">
        {% for comment in comments %}
        <div class="comment p-2 border-b">
            <p class="text-sm">{{ comment.author }}: {{ comment.text }}</p>
            <span class="text-xs text-gray-400">{{ comment.created_at }}</span>
        </div>
        {% endfor %}
    </div>
    {% if ticket.ticket_id %}
    <form action="{% url 'add_comment' ticket.ticket_id %}" method="POST" class="mt-4">
        {% csrf_token %}
        <textarea name="comment" rows="3" class="w-full border rounded p-2" placeholder="Add a comment"></textarea>
        <button type="submit" class="bg-blue-500 text-white rounded p-2 mt-2">Submit</button>
    </form>
    {% else %}
    <p>Error: No valid ticket ID found.</p>
    {% endif %}
</div>


 -->


<!-- ticket_details.html -->
<div class="p-4">
    <h3 class="text-lg font-semibold">Details</h3>
    <h1>{{ ticket.ticket_title }}</h1>
    <p class="text-gray-500">{{ ticket.ticket_description }}</p>
    <h3 class="text-lg font-semibold mt-4">Comments</h3>
    <div class="comments mt-2" id="comment-section">
        {% for comment in comments %}
        <div class="comment p-2 border-b">
            <p class="text-sm">{{ comment.author }}: {{ comment.text }}</p>
            <span class="text-xs text-gray-400">{{ comment.created_at }}</span>
        </div>
        {% empty %}
        <p>No comments yet.</p>
        {% endfor %}
    </div>
    <form id="comment-form" method="post" data-ticket-id="{{ ticket.ticket_id }}" class="mt-4">
        {% csrf_token %}
        <textarea id="comment-textarea" name="comment" rows="3" class="w-full border rounded p-2" placeholder="Add a comment"></textarea>
        <button type="submit" class="bg-blue-500 text-white rounded p-2 mt-2">Submit</button>
    </form>
</div>

<script>
     // Function to get the CSRF token from the cookies
     function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.getElementById('comment-form').addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent default form submission

        const ticketId = this.getAttribute('data-ticket-id');
        const commentTextarea = document.getElementById('comment-textarea');
        const commentText = commentTextarea.value.trim();
        const csrfToken = getCookie('csrftoken'); // Get the CSRF token

        if (commentText === '') {
            alert('Please enter a comment.');
            return;
        }

        // Create FormData object to send the form data as form submission
        const formData = new FormData();
        formData.append('comment', commentText);
        formData.append('csrfmiddlewaretoken', csrfToken);

        fetch(`/add-comment/${ticketId}/`, {
            method: 'POST',
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            if (data.comment) {
                const commentSection = document.getElementById('comment-section');
                const newCommentHTML = `
                    <div class="comment p-2 border-b">
                        <p class="text-sm">${data.comment.author}: ${data.comment.text}</p>
                        <span class="text-xs text-gray-400">${data.comment.created_at}</span>
                    </div>
                `;
                commentSection.insertAdjacentHTML('beforeend', newCommentHTML);
                commentTextarea.value = ''; 
            } else if (data.error) {
                alert(data.error);
            }
        })
        .catch(error => console.error('Error adding comment:', error));
    });
</script>
