<html>

<head>
    <title> {{ ticket.ticket_title }} </title>
    <script src="https://cdn.tailwindcss.com"></script>

</head>

<body>
    <div class="p-4 lg:p-8">
        <h1 class="text-2xl font-semibold tracking-wide "> {{ ticket.ticket_title }} </h1>
        <div class="flex flex-row gap-2 w-fit  items-center">
            {% if not ticket.resolved %}
            <div class="text-white bg-yellow-600 w-fit text-sm rounded px-1 ">
                <p>Open</p>
            </div>
            {% else %}
            <div class="text-white flex items-center bg-green-600 w-fit  text-sm rounded px-1">
                Resolved
            </div>
            {% endif %}
        </div>
        <p class="text-gray-500 py-3">{{ ticket.ticket_description }}</p>
        {% if ticket.image %}
        <div class="max-w-[200px]">
            <a target="_blank" href="{{ ticket.image.url }}">
                <div
                    class="text-base py-1 border border-gray-400 px-2 bg-gray-100 rounded underline flex gap-1 hover:bg-gray-200 ">
                    <img src="/static/images/attachment.png" width="13" height="13" alt="attachment"> 1
                    attachment
                </div>
            </a>
        </div>
        {% endif %}
        <h3 class="text-lg font-semibold mt-4">Comments</h3>
        <div class=" mt-2">
            {% if comments %}
            {% for comment in comments %}
            <div class="comment p-2 border-b-2 ">
                <div class="flex gap-1 w-fit items-center justify-center">
                    <img src="/static/images/avatar.png" width="18" height="18" alt="">
                    <div class="font-semibold mb-1">{{ comment.author }}</div>
                </div>
                <div class="text-xs px-2 text-gray-400">{{ comment.created_at }}</div>
                <div class="p-3"> {{ comment.text }} </div>
            </div>
            {% endfor %}

            {% else %}
            <div> No comments yet </div>

            {% endif %}
        </div>
        {% if ticket.ticket_id and not ticket.resolved %}
        <form action="{% url 'add_comment' ticket.ticket_id %}" method="POST"
            class="mt-4 flex w-full gap-2 justify-around items-center">
            {% csrf_token %}
            <textarea name="comment" rows="1" class="w-5/6 border-2 border-gray-400 rounded p-2"
                placeholder="Start typing ...." required></textarea>
            <button type="submit"
                class="bg-gray-500 flex items-center justify-center  w-1/3 text-white rounded p-2 hover:bg-gray-700 ">Submit
                <img src="/static/images/send.svg" width="18" height="14" alt=""></button>
        </form>
        {% else %}
        <div class="bg-gray-200 px-6 w-fit mt-4 rounded-md"> This ticket has been closed  </div>
        {% endif %}

        {% if not ticket.resolved %}
        <form action="{% url 'resolve_ticket' ticket.ticket_id %}" class="flex mt-4" method="POST">
            {% csrf_token %}
            <button type="submit"
                class="text-white bg-blue-500 font-semibold w-30 text-xs rounded p-1 border border-blue-800 shadow-xl shadow-blue-500/20 mt-1 hover:bg-blue-600">
                Mark as Resolved
            </button>
        </form>
        {% endif %}
    </div>




</body>

<!-- ticket_details.html -->
<!-- <div class="p-4">
        <h3 class="text-lg font-semibold">Details</h3>
        <h1>{{ ticket.ticket_title }}</h1>
        <p class="text-gray-500">{{ ticket.ticket_description }}</p>
        <h3 class="text-lg font-semibold mt-4">Comments</h3>
        <div class="comments mt-2" id="comment-section">
            {% for comment in comments %}
            <div class="comment p-2 border-b">
            <p class="text-sm">{{ comment.author }}: {{ comment.text }}</p>
            <span class="text-xs text-gray-400">{{ comment.created_at }}</span>
        </div>
        {% empty %}
        <p>No comments yet.</p>
        {% endfor %}
    </div>
    <form id="comment-form" method="post" data-ticket-id="{{ ticket.ticket_id }}" class="mt-4">
        {% csrf_token %}
        <textarea id="comment-textarea" name="comment" rows="3" class="w-full border rounded p-2" placeholder="Add a comment"></textarea>
        <button type="submit" class="bg-blue-500 text-white rounded p-2 mt-2">Submit</button>
    </form>
</div> -->
<!-- 
<script>
     // Function to get the CSRF token from the cookies
     function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.getElementById('comment-form').addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent default form submission

        const ticketId = this.getAttribute('data-ticket-id');
        const commentTextarea = document.getElementById('comment-textarea');
        const commentText = commentTextarea.value.trim();
        const csrfToken = getCookie('csrftoken'); // Get the CSRF token

        if (commentText === '') {
            alert('Please enter a comment.');
            return;
        }

        // Create FormData object to send the form data as form submission
        const formData = new FormData();
        formData.append('comment', commentText);
        formData.append('csrfmiddlewaretoken', csrfToken);

        fetch(`/add-comment/${ticketId}/`, {
            method: 'POST',
            body: formData,
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.comment) {
                const commentSection = document.getElementById('comment-section');
                const newCommentHTML = `
                    <div class="comment p-2 border-b">
                        <p class="text-sm">${data.comment.author}: ${data.comment.text}</p>
                        <span class="text-xs text-gray-400">${data.comment.created_at}</span>
                    </div>
                `;
                commentSection.insertAdjacentHTML('beforeend', newCommentHTML);
                commentTextarea.value = ''; 
            } else if (data.error) {
                alert(data.error);
            }
        })
        .catch(error => console.error('Error adding comment:', error));
    });
</script> -->


</html>